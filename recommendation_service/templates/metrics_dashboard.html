<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommendation System Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .overall-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            color: #333;
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .stat-card .value.percentage {
            color: #667eea;
        }
        
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .model-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .model-card h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .model-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.6em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-two-tower {
            background: #667eea;
            color: white;
        }
        
        .badge-als {
            background: #f093fb;
            color: white;
        }
        
        .badge-reverse {
            background: #4facfe;
            color: white;
        }
        
        .model-info {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .metric-item .label {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        
        .metric-item .value {
            color: #333;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .chart-container {
            margin-top: 20px;
            height: 300px;
            position: relative;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Recommendation System Metrics</h1>
            <p>Real-time evaluation metrics for all recommendation models</p>
        </div>
        
        <div id="errorContainer"></div>
        
        <div id="overallStats" class="overall-stats"></div>
        
        <div id="modelsContainer" class="models-grid"></div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        
        async function loadMetrics() {
            const url = `${API_BASE}/api/recommendations/metrics`;
            
            try {
                document.getElementById('modelsContainer').innerHTML = '<div class="loading">Loading metrics...</div>';
                document.getElementById('errorContainer').innerHTML = '';
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                renderMetrics(data);
            } catch (error) {
                document.getElementById('errorContainer').innerHTML = 
                    `<div class="error">Error loading metrics: ${error.message}</div>`;
                document.getElementById('modelsContainer').innerHTML = '';
            }
        }
        
        function renderMetrics(data) {
            // Render overall stats
            const overallStats = data.overall_metrics;
            const statsHtml = `
                <div class="stat-card">
                    <h3>Total Models</h3>
                    <div class="value">${overallStats.total_models}</div>
                </div>
                <div class="stat-card">
                    <h3>Active Models</h3>
                    <div class="value">${overallStats.active_models}</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Precision@10</h3>
                    <div class="value percentage">${(overallStats.average_precision * 100).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Recall@10</h3>
                    <div class="value percentage">${(overallStats.average_recall * 100).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h3>Avg NDCG@10</h3>
                    <div class="value percentage">${(overallStats.average_ndcg * 100).toFixed(2)}%</div>
                </div>
            `;
            document.getElementById('overallStats').innerHTML = statsHtml;
            
            // Render model cards
            if (data.models.length === 0) {
                document.getElementById('modelsContainer').innerHTML = 
                    '<div class="loading">No models found matching the filters.</div>';
                return;
            }
            
            const modelsHtml = data.models.map(model => {
                const metrics = model.metrics;
                const badgeClass = model.type === 'two_tower' ? 'badge-two-tower' : 'badge-als';
                const reverseBadge = model.is_reverse ? '<span class="model-badge badge-reverse">Reverse</span>' : '';
                
                const metricsHtml = `
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="label">Precision@10</div>
                            <div class="value">${(metrics['precision@10'] * 100).toFixed(2)}%</div>
                        </div>
                        <div class="metric-item">
                            <div class="label">Recall@10</div>
                            <div class="value">${(metrics['recall@10'] * 100).toFixed(2)}%</div>
                        </div>
                        <div class="metric-item">
                            <div class="label">NDCG@10</div>
                            <div class="value">${(metrics['ndcg@10'] * 100).toFixed(2)}%</div>
                        </div>
                        <div class="metric-item">
                            <div class="label">MAP</div>
                            <div class="value">${(metrics['map'] * 100).toFixed(2)}%</div>
                        </div>
                        <div class="metric-item">
                            <div class="label">Hit Rate@10</div>
                            <div class="value">${(metrics['hit_rate@10'] * 100).toFixed(2)}%</div>
                        </div>
                        <div class="metric-item">
                            <div class="label">Coverage</div>
                            <div class="value">${(metrics['coverage'] * 100).toFixed(2)}%</div>
                        </div>
                    </div>
                `;
                
                // Create chart data
                const kValues = [10, 20, 50];
                const precisionData = kValues.map(k => metrics[`precision@${k}`] || 0);
                const recallData = kValues.map(k => metrics[`recall@${k}`] || 0);
                const ndcgData = kValues.map(k => metrics[`ndcg@${k}`] || 0);
                
                const chartId = `chart-${model.name.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                return `
                    <div class="model-card">
                        <h2>
                            ${model.name}
                            <span class="model-badge ${badgeClass}">${model.type}</span>
                            ${reverseBadge}
                        </h2>
                        <div class="model-info">
                            Use Case: ${model.use_case} | 
                            Test Entities: ${model.num_test_entities} |
                            Evaluated: ${new Date(model.evaluation_date).toLocaleString()}
                        </div>
                        ${metricsHtml}
                        <div class="chart-container">
                            <canvas id="${chartId}"></canvas>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('modelsContainer').innerHTML = modelsHtml;
            
            // Render charts
            data.models.forEach(model => {
                const chartId = `chart-${model.name.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const ctx = document.getElementById(chartId);
                if (ctx) {
                    const metrics = model.metrics;
                    const kValues = [10, 20, 50];
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: kValues.map(k => `K=${k}`),
                            datasets: [
                                {
                                    label: 'Precision@K',
                                    data: kValues.map(k => (metrics[`precision@${k}`] || 0) * 100),
                                    borderColor: 'rgb(102, 126, 234)',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'Recall@K',
                                    data: kValues.map(k => (metrics[`recall@${k}`] || 0) * 100),
                                    borderColor: 'rgb(240, 147, 251)',
                                    backgroundColor: 'rgba(240, 147, 251, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'NDCG@K',
                                    data: kValues.map(k => (metrics[`ndcg@${k}`] || 0) * 100),
                                    borderColor: 'rgb(79, 172, 254)',
                                    backgroundColor: 'rgba(79, 172, 254, 0.1)',
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Metrics at Different K Values'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            });
        }
        
        // Load metrics on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadMetrics();
        });
    </script>
</body>
</html>

